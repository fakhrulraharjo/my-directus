"use strict";class i{constructor(i){this.data=i,this.cardFull=this._convert()}_convert(){const i=this.data.batch_id.card.attribute_ids.map((i=>({id:i.attribute_id.id,value:i.value})));return{id:this.data.id,unique_id:this.data.unique_id,card_id:this.data.batch_id.card.id,name:this.data.batch_id.card.name,unique:this.data.batch_id.card.name,powers:i}}powerAttributeId(){return this.cardFull.powers.map((i=>i.id))}print(){return this.cardFull}}const t=["id","start_date","end_date","mission.*.id","mission.*.condition","mission.*.value","mission.*.attribute_id.*"];class a{constructor(i){this.data=i,this.voucherFull=this._convert(i)}_convert(i){const t=i.mission.attributes.map((i=>({attributeId:i.attribute_id.id,value:i.value,condition:i.condition,id:i.id}))),a={id:i.mission.id,status:i.mission.status,name:i.mission.name,description:i.mission.description,badge:i.mission.badge.id,condition:t};return{id:i.id,start_date:i.start_date,end_date:i.end_date,mission:a}}conditionAttributeId(){return this.voucherFull.mission.condition.map((i=>i.attributeId))}verify(i){var t=!1,a=[...this.voucherFull.mission.condition],e=this.voucherFull.mission.condition.length,r=[];return 0==e&&(t=!0),a.forEach(((a,d)=>{if(0==e)return t=!0;i.forEach((i=>{if(0==e)return t=!0;const d=i.print();d.powers.forEach((i=>{if(0==e)return t=!0;if(a.attributeId===i.id)switch(a.condition){case"_gt":case"_gte":i.value>a.value&&e--,r.push(d);break;case"_lt":case"_lte":i.value<a.value&&e--,r.push(d)}}))}))})),{resolved:t,challanger:r}}print(){return this.voucherFull}}var e=(e,{services:r,exceptions:d})=>{const{ItemsService:s}=r,{ServiceUnavailableException:n}=d;e.put("/",(async(e,r,d)=>{const c=new s("batch_vouchers",{schema:e.schema,accountability:e.accountability}),o=new s("card_serials",{schema:e.schema,accountability:e.accountability}),u=new s("vouchers",{schema:e.schema,accountability:e.accountability}),h=async(i,t)=>{const a=await(async i=>await u.readByQuery({filter:{_and:[{status:{_eq:"available"}},{batch_id:{_eq:i}},{user_id:{_null:!0}}]},limit:1}))(i);if(0==a.length)throw new Error("No Voucher avilable");return await u.updateOne(a[0].id,{user_id:t})},l=o.readByQuery({fields:["id","unique_id","batch_id.id","batch_id.card.id","batch_id.card.name","batch_id.card.unique","batch_id.card.attribute_ids.id","batch_id.card.attribute_ids.value","batch_id.card.attribute_ids.attribute_id.id"],filter:{_and:[{user_id:{_eq:e.body.user_id}},{redeemed:{_eq:!1}}]}});try{const d=await c.readOne(e.body.voucher_id,{fields:t}),s=(await l).map((t=>new i(t))),n=new a(d),{resolved:u,challanger:_}=n.verify(s);if(u){const i=await h(n.print().id,e.body.user_id);return await(async i=>{const t=i.map((i=>i.id));return await o.updateMany(t,{redeemed:!0})})(_),r.json({data:{id:i}})}throw new Error("Condition not met.")}catch(i){return d(new n(i.message))}}))};module.exports=e;
